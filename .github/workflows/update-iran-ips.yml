name: Generate MikroTik Iran IP List
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
concurrency:
  group: generate-mikrotik-iran-ip-list
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate RSC Files
        run: |
          set -euo pipefail
          
          # Initialize files with headers
          echo "# Generated on $(date)" > iran_list.rsc
          echo "# Generated on $(date)" > iran_routes.rsc
          
          # Declare globals at the top so the /import scope can see them
          echo ":global irtable" >> iran_routes.rsc
          echo ":global irgw" >> iran_routes.rsc          
          
          # Cleanup logic
          echo "/ip firewall address-list remove [find list=\"IRAN_IPS\"]" >> iran_list.rsc
          # Quoting \"\$irtable\" prevents the 'ambiguous' error in RouterOS v7
          echo "/ip route remove [find comment=\"IR_BGP_DATA\" routing-table=\"\$irtable\"]" >> iran_routes.rsc          
          echo ":delay 2s" >> iran_routes.rsc
          
          # Fetch IP data
          if ! ip_data=$(curl -fsSL https://raw.githubusercontent.com/ipverse/rir-ip/master/country/ir/ipv4-aggregated.txt); then
            echo "Error: Failed to fetch IP data"
            exit 1
          fi
          
          if [ -z "$ip_data" ]; then
            echo "Error: Fetched IP data is empty; aborting."
            exit 1
          fi
          
          # Process the data
          echo "$ip_data" | grep -v '^#' | while read -r line; do
            if [[ "$line" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}/(3[0-2]|[12][0-9]|[0-9])$ ]]; then
              echo "/ip firewall address-list add list=IRAN_IPS address=$line" >> iran_list.rsc
              # Essential: Quote the variables to ensure ROS v7 treats them as strings
              echo "/ip route add distance=50 dst-address=$line gateway=\"\$irgw\" routing-table=\"\$irtable\" comment=\"IR_BGP_DATA\"" >> iran_routes.rsc
            fi
          done
          
          echo ":log info \"Iran IP Address List generated.\"" >> iran_list.rsc
          echo ":log info \"Iran Routes generated for table \$irtable.\"" >> iran_routes.rsc

      - name: Commit and Push
        run: |
          set -euo pipefail
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add iran_list.rsc iran_routes.rsc     
          
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          git commit -m "Update Iran IP List"
          if ! git push; then
            echo "Error: git push failed."
            exit 1
          fi
