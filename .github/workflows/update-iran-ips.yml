name: Generate MikroTik Iran IP List
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
concurrency:
  group: generate-mikrotik-iran-ip-list
  cancel-in-progress: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate RSC Files
        run: |
          set -euo pipefail
          
          # Initialize files with headers
          echo "# Generated on $(date)" > iran_list.rsc
          echo "# Generated on $(date)" > iran_routes.rsc
          
          # Cleanup logic for each file
          echo "/ip firewall address-list remove [find list=\"IRAN_IPS\"]" >> iran_list.rsc
          echo "/ip route remove [find comment=\"IR_BGP_DATA\"]" >> iran_routes.rsc
          
          # Fetch IP data
          if ! ip_data=$(curl -fsSL https://raw.githubusercontent.com/ipverse/rir-ip/master/country/ir/ipv4-aggregated.txt); then
            echo "Error: Failed to fetch IP data"
            exit 1
          fi
          
          # Process the data
          echo "$ip_data" | grep -v '^#' | while read -r line; do
            if [[ "$line" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}/(3[0-2]|[12][0-9]|[0-9])$ ]]; then
              # Write to the Address List file
              echo "/ip firewall address-list add list=IRAN_IPS address=$line" >> iran_list.rsc
              # Write to the Routes file (using variables)
              echo "/ip route add dst-address=$line gateway=\$irgw routing-table=\$irtable comment=\"IR_BGP_DATA\"" >> iran_routes.rsc
            fi
          done
          
          echo ":log info \"Iran IP Address List generated.\"" >> iran_list.rsc
          echo ":log info \"Iran Routes generated for table \$irtable via \$irgw.\"" >> iran_routes.rsc

      - name: Commit and Push
        run: |
          set -euo pipefail
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add iran.rsc
          
          # If there are no staged changes, skip commit and push
          if git diff --cached --quiet; then
            echo "No changes to commit; skipping push."
            exit 0
          fi
          
          git commit -m "Update Iran IP List"
          
          # Fail explicitly (with message) if push does not succeed
          if ! git push; then
            echo "Error: git push failed. Changes were not published."
            exit 1
          fi
